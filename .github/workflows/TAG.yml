name: CI/CD ESP-IDF Build + Auto Tag + Release

on:
  push:
    branches:
      - cmd-reset-eeprom  # Only run on merges to main

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    container:
      image: espressif/idf:latest  # Official ESP-IDF Docker image

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0  # fetch all history for tags

      # 2️⃣ Configure Git
      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      # 3️⃣ Get latest tag
      - name: Get latest tag
        id: get_tag
        run: |
          git fetch --tags
          LATEST_TAG=$(git describe --tags --abbrev=0 || echo "v0.0.0")
          echo "LATEST_TAG=$LATEST_TAG"
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV

      # 4️⃣ Bump patch version
      - name: Bump version (patch)
        id: bump
        run: |
          IFS='.' read -r MAJOR MINOR PATCH <<< "${LATEST_TAG#v}"
          PATCH=$((PATCH + 1))
          NEW_TAG="v$MAJOR.$MINOR.$PATCH"

          # Safety: avoid duplicate tags
          while git rev-parse "$NEW_TAG" >/dev/null 2>&1; do
            PATCH=$((PATCH + 1))
            NEW_TAG="v$MAJOR.$MINOR.$PATCH"
          done

          echo "NEW_TAG=$NEW_TAG"
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV

      # 5️⃣ Create and push tag
      - name: Create and push tag
        run: |
          git tag "$NEW_TAG"
          git push origin "$NEW_TAG"

      # 6️⃣ Build ESP-IDF firmware
      - name: Build firmware
        shell: bash
        run: |
          export IDF_TARGET=esp32
          . /opt/esp/idf/export.sh
          idf.py fullclean build -DPROJECT_VER="${NEW_TAG}"

      # 7️⃣ Collect firmware binary
      - name: Prepare release artifacts
        run: |
          mkdir -p release
          cp build/firmware-idf.bin release/cn1.bin

      # 8️⃣ Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.NEW_TAG }}
          name: Release ${{ env.NEW_TAG }}
          body: "Firmware release ${{ env.NEW_TAG }}"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 9️⃣ Upload firmware to release
      - name: Upload firmware binary to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.NEW_TAG }}
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
